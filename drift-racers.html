<!DOCTYPE html>

<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>„Éâ„É™„Éï„Éà„É¨„Éº„Çµ„Éº„Ç∫ 3D</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#000;overflow:hidden;font-family:'Trebuchet MS','Hiragino Sans',sans-serif;touch-action:none;user-select:none;-webkit-user-select:none}
canvas{display:block}

/* Rotate prompt */
#rotate-prompt{position:fixed;inset:0;background:rgba(0,0,0,.95);z-index:9999;display:none;flex-direction:column;align-items:center;justify-content:center;color:#fff}
#rotate-prompt .icon{font-size:60px;animation:rot 2s infinite}
#rotate-prompt p{margin-top:15px;font-size:18px}
@keyframes rot{0%,100%{transform:rotate(0deg)}50%{transform:rotate(90deg)}}

/* Title */
#title-screen{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:100;background:linear-gradient(135deg,#080820 0%,#1a0a3e 40%,#0a2a4e 100%)}
#title-screen::before{content:‚Äô‚Äô;position:absolute;inset:0;background:radial-gradient(ellipse at 30% 20%,rgba(255,100,0,.15),transparent 60%),radial-gradient(ellipse at 70% 80%,rgba(0,100,255,.15),transparent 60%)}
.title-logo{position:relative;z-index:1;text-align:center;margin-bottom:30px}
.title-main{font-size:min(10vw,72px);font-weight:900;color:#fff;text-shadow:0 0 40px rgba(255,150,0,.4),0 4px 0 #c60,0 8px 0 #a40;letter-spacing:4px}
.title-sub{font-size:min(4vw,24px);color:#ffd700;text-shadow:0 0 15px rgba(255,215,0,.5);margin-top:5px;letter-spacing:8px}
.char-select{position:relative;z-index:1;display:flex;gap:12px;flex-wrap:wrap;justify-content:center;margin-bottom:30px;max-width:500px}
.char-card{width:100px;height:130px;border-radius:16px;border:3px solid rgba(255,255,255,.2);background:rgba(255,255,255,.08);backdrop-filter:blur(8px);cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;transition:all .25s;padding:8px}
.char-card:hover,.char-card.sel{border-color:#ffd700;background:rgba(255,215,0,.15);transform:scale(1.08)}
.char-card .emoji{font-size:36px;margin-bottom:4px}
.char-card .name{color:#fff;font-size:12px;font-weight:700}
.char-card .type{color:rgba(255,255,255,.6);font-size:10px}
.char-stats{display:flex;gap:3px;margin-top:4px}
.char-stats span{width:8px;height:8px;border-radius:2px;background:rgba(255,255,255,.2)}
.char-stats span.filled{background:#ffd700}
.start-btn{position:relative;z-index:1;padding:16px 50px;font-size:22px;font-weight:900;color:#fff;background:linear-gradient(135deg,#ff4400,#ff8800);border:none;border-radius:50px;cursor:pointer;letter-spacing:4px;text-shadow:0 2px 4px rgba(0,0,0,.4);box-shadow:0 6px 25px rgba(255,68,0,.4);transition:all .2s}
.start-btn:hover{transform:translateY(-2px);box-shadow:0 10px 35px rgba(255,68,0,.6)}
.start-btn:active{transform:translateY(1px)}
.course-label{position:relative;z-index:1;color:rgba(255,255,255,.7);font-size:14px;margin-bottom:20px}

/* HUD */
#hud{position:fixed;top:0;left:0;width:100%;pointer-events:none;z-index:10;display:none;padding:12px 16px}
.hud-top{display:flex;justify-content:space-between;align-items:flex-start}
.hud-box{background:rgba(0,0,0,.55);border:1.5px solid rgba(255,255,255,.2);border-radius:10px;padding:8px 14px;color:#fff;font-size:15px;font-weight:700;backdrop-filter:blur(6px)}
#position-display{font-size:28px;color:#ffd700;text-shadow:0 0 10px rgba(255,215,0,.5);min-width:60px;text-align:center}
#position-display .suffix{font-size:14px;color:rgba(255,255,255,.6)}
#speed-display{color:#0f0;font-variant-numeric:tabular-nums}
#lap-display{text-align:center}
#item-box{width:60px;height:60px;border-radius:14px;background:rgba(0,0,0,.6);border:2.5px solid #ffd700;display:flex;align-items:center;justify-content:center;font-size:32px;box-shadow:0 0 15px rgba(255,215,0,.3);transition:transform .15s}
#item-box.has-item{animation:itemPulse .6s ease}
@keyframes itemPulse{0%{transform:scale(1)}50%{transform:scale(1.2)}100%{transform:scale(1)}}

/* Countdown */
#countdown{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:50;pointer-events:none}
#countdown .num{font-size:120px;font-weight:900;color:#fff;text-shadow:0 0 60px rgba(255,150,0,.6);animation:cdPop .8s ease-out}
@keyframes cdPop{0%{transform:scale(2);opacity:0}30%{transform:scale(1);opacity:1}100%{opacity:0}}

/* Results */
#results{position:fixed;inset:0;display:none;flex-direction:column;align-items:center;justify-content:center;z-index:100;background:rgba(0,0,0,.85);backdrop-filter:blur(10px)}
#results h2{font-size:42px;color:#ffd700;text-shadow:0 0 30px rgba(255,215,0,.4);margin-bottom:10px}
#results .time{font-size:22px;color:#fff;margin-bottom:25px}
.result-list{list-style:none;width:min(90%,400px)}
.result-list li{display:flex;align-items:center;gap:12px;padding:10px 16px;margin:4px 0;border-radius:10px;font-size:16px;color:#fff;background:rgba(255,255,255,.06)}
.result-list li.player{background:rgba(255,215,0,.12);border:1px solid rgba(255,215,0,.3)}
.result-list .rank{font-size:22px;font-weight:900;width:35px;text-align:center}
.result-list .rank.g{color:#ffd700}.result-list .rank.s{color:#c0c0c0}.result-list .rank.b{color:#cd7f32}
.retry-btn{margin-top:25px;padding:14px 40px;font-size:18px;font-weight:700;color:#fff;background:linear-gradient(135deg,#0066ff,#0099ff);border:none;border-radius:40px;cursor:pointer;letter-spacing:2px}

/* Minimap */
#minimap{position:fixed;bottom:12px;right:12px;width:130px;height:130px;border-radius:10px;background:rgba(0,0,0,.5);border:1.5px solid rgba(255,255,255,.2);backdrop-filter:blur(4px);z-index:10;display:none}

/* Mobile Controls */
#mobile-controls{position:fixed;bottom:0;left:0;width:100%;z-index:20;display:none;padding:10px 16px 20px;pointer-events:none}
.ctrl-row{display:flex;justify-content:space-between;align-items:flex-end}
.ctrl-btn{pointer-events:auto;border-radius:50%;border:2px solid rgba(255,255,255,.3);background:rgba(255,255,255,.1);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:900;-webkit-tap-highlight-color:transparent}
.ctrl-btn:active,.ctrl-btn.pressed{background:rgba(255,255,255,.3);border-color:rgba(255,255,255,.5)}
.dpad{position:relative;width:140px;height:140px}
.dpad .ctrl-btn{position:absolute;width:48px;height:48px;font-size:20px}
.dpad .up{top:0;left:50%;transform:translateX(-50%)}
.dpad .down{bottom:0;left:50%;transform:translateX(-50%)}
.dpad .left{left:0;top:50%;transform:translateY(-50%)}
.dpad .right{right:0;top:50%;transform:translateY(-50%)}
.action-btns{display:flex;gap:10px;align-items:flex-end}
.action-btns .ctrl-btn{width:56px;height:56px;font-size:13px}
.btn-accel{width:64px!important;height:64px!important;background:rgba(0,200,0,.25)!important;border-color:rgba(0,200,0,.5)!important;font-size:11px!important}
.btn-brake{background:rgba(255,0,0,.2)!important;border-color:rgba(255,0,0,.4)!important}
.btn-drift{background:rgba(0,100,255,.2)!important;border-color:rgba(0,100,255,.4)!important}
.btn-item{background:rgba(255,200,0,.2)!important;border-color:rgba(255,200,0,.4)!important}

/* Boost bar */
#boost-bar{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);width:min(60%,250px);height:8px;border-radius:4px;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.15);z-index:15;display:none;overflow:hidden}
#boost-fill{height:100%;border-radius:3px;background:linear-gradient(90deg,#ff4400,#ffaa00);width:0%;transition:width .1s}

/* Warning flash */
#warning-flash{position:fixed;inset:0;pointer-events:none;z-index:8;opacity:0;background:radial-gradient(ellipse at center,transparent 40%,rgba(255,0,0,.3));transition:opacity .15s}
</style>

</head>
<body>

<div id="rotate-prompt"><div class="icon">üì±</div><p>Ê®™Âêë„Åç„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p></div>

<div id="title-screen">
  <div class="title-logo">
    <div class="title-main">DRIFT RACERS</div>
    <div class="title-sub">„Éâ„É™„Éï„Éà„É¨„Éº„Çµ„Éº„Ç∫</div>
  </div>
  <div class="course-label">üèÅ „É¨„Ç§„É≥„Éú„Éº„Çµ„Éº„Ç≠„ÉÉ„Éà - 3 LAPS</div>
  <div class="char-select" id="char-select"></div>
  <button class="start-btn" id="start-btn">START RACE</button>
</div>

<div id="hud">
  <div class="hud-top">
    <div id="position-display" class="hud-box">1<span class="suffix">st</span></div>
    <div id="lap-display" class="hud-box">LAP 1/3</div>
    <div id="item-box"></div>
  </div>
  <div style="display:flex;justify-content:space-between;margin-top:6px">
    <div id="speed-display" class="hud-box">0 km/h</div>
    <div id="time-display" class="hud-box">0:00.00</div>
  </div>
</div>

<div id="countdown"><div class="num" id="cd-num">3</div></div>

<div id="results">
  <h2 id="result-title">FINISH!</h2>
  <div class="time" id="result-time"></div>
  <ol class="result-list" id="result-list"></ol>
  <button class="retry-btn" id="retry-btn">RETRY</button>
</div>

<canvas id="minimap" width="260" height="260"></canvas>

<div id="boost-bar"><div id="boost-fill"></div></div>

<div id="warning-flash"></div>

<div id="mobile-controls">
  <div class="ctrl-row">
    <div class="dpad">
      <div class="ctrl-btn up" data-key="up">‚ñ≤</div>
      <div class="ctrl-btn down" data-key="down">‚ñº</div>
      <div class="ctrl-btn left" data-key="left">‚óÄ</div>
      <div class="ctrl-btn right" data-key="right">‚ñ∂</div>
    </div>
    <div class="action-btns">
      <div class="ctrl-btn btn-item" data-key="item">ITEM</div>
      <div class="ctrl-btn btn-drift" data-key="drift">DRIFT</div>
      <div class="ctrl-btn btn-brake" data-key="brake">BRAKE</div>
      <div class="ctrl-btn btn-accel" data-key="accel">GAS</div>
    </div>
  </div>
</div>

<script>
// ===== AUDIO =====
var actx=null;
function initAudio(){if(!actx)try{actx=new(window.AudioContext||window.webkitAudioContext)}catch(e){}}
function tone(f,d,t,v,f2){if(!actx)return;try{var o=actx.createOscillator(),g=actx.createGain();o.type=t||'sine';o.frequency.value=f;if(f2)o.frequency.linearRampToValueAtTime(f2,actx.currentTime+d);g.gain.value=v||.1;g.gain.linearRampToValueAtTime(0,actx.currentTime+d);o.connect(g);g.connect(actx.destination);o.start();o.stop(actx.currentTime+d+.01)}catch(e){}}
function noise(d,v){if(!actx)return;try{var b=actx.createBuffer(1,actx.sampleRate*d|0||4410,actx.sampleRate),a=b.getChannelData(0);for(var i=0;i<a.length;i++)a[i]=Math.random()*2-1;var n=actx.createBufferSource(),g=actx.createGain();n.buffer=b;g.gain.value=v||.08;g.gain.linearRampToValueAtTime(0,actx.currentTime+d);n.connect(g);g.connect(actx.destination);n.start()}catch(e){}}
var SND={
  cd:function(){tone(440,.3,'square',.04)},
  go:function(){tone(880,.35,'square',.06);setTimeout(function(){tone(1100,.2,'square',.04)},80)},
  pick:function(){tone(600,.06,'sine',.07);setTimeout(function(){tone(900,.06,'sine',.07)},60);setTimeout(function(){tone(1200,.08,'sine',.07)},120)},
  boost:function(){tone(200,.35,'sawtooth',.04,500)},
  hit:function(){noise(.12,.1);tone(200,.1,'square',.05,80)},
  lap:function(){tone(660,.07,'square',.05);setTimeout(function(){tone(880,.07,'square',.05)},90);setTimeout(function(){tone(1100,.1,'square',.06)},180)},
  fin:function(){for(var i=0;i<5;i++)(function(i){setTimeout(function(){tone(500+i*150,.1,'square',.04)},i*70)})(i)},
  drift:function(){tone(80,.06,'sawtooth',.015)}
};

// ===== CONFIG =====
var CHARACTERS=[
  {n:'„Éñ„É¨„Ç§„Ç∫',e:'üî•',col:0xFF4400,s:9,a:6,h:5,d:'„Çπ„Éî„Éº„ÉâÂûã',bc:0xCC2200,hc:0xFF8844},
  {n:'„Ç¢„ÇØ„Ç¢',e:'üíß',col:0x0088FF,s:6,a:7,h:8,d:'„ÉÜ„ÇØ„Éã„ÉÉ„ÇØÂûã',bc:0x0055CC,hc:0x66BBFF},
  {n:'„ÉÜ„É©',e:'üåø',col:0x22CC44,s:7,a:8,h:6,d:'„Éê„É©„É≥„ÇπÂûã',bc:0x118822,hc:0x66FF88},
  {n:'„Ç∑„É£„Éâ„Ç¶',e:'üåô',col:0x8844CC,s:10,a:5,h:5,d:'ÊúÄÈ´òÈÄüÂûã',bc:0x5522AA,hc:0xBB77FF},
  {n:'„ÇΩ„É©',e:'‚òÄÔ∏è',col:0xFFAA00,s:5,a:9,h:7,d:'Âä†ÈÄüÂûã',bc:0xCC7700,hc:0xFFDD66}
];

var ITEMS=[
  {n:'„É≠„Ç±„ÉÉ„Éà',e:'üöÄ',type:'boost'},
  {n:'„Éê„Éä„ÉäÁàÜÂºæ',e:'üí£',type:'trap'},
  {n:'„Éõ„Éº„Éü„É≥„Ç∞Âºæ',e:'üéØ',type:'homing'},
  {n:'„Ç∑„Éº„É´„Éâ',e:'üõ°Ô∏è',type:'shield'},
  {n:'„Çµ„É≥„ÉÄ„Éº',e:'‚ö°',type:'thunder'}
];

var TOTAL_LAPS=3, NUM_RACERS=6, TRACK_POINTS=100, TRACK_WIDTH=28;

// ===== TRACK GENERATION =====
var trackNodes=[], trackMeshes=[];
function generateTrack(){
  trackNodes=[];
  for(var i=0;i<TRACK_POINTS;i++){
    var t=i/TRACK_POINTS*Math.PI*2;
    var r=280+80*Math.sin(t*2)+50*Math.cos(t*3)+30*Math.sin(t*5+1);
    var y=8*Math.sin(t*3)+5*Math.cos(t*2+.5);
    trackNodes.push({x:r*Math.cos(t),y:y,z:r*Math.sin(t)});
  }
}

function getTrackPoint(i){return trackNodes[((i%TRACK_POINTS)+TRACK_POINTS)%TRACK_POINTS]}
function getTrackAngle(i){var a=getTrackPoint(i),b=getTrackPoint(i+1);return Math.atan2(b.z-a.z,b.x-a.x)}
function getTrackDir(i){var a=getTrackPoint(i),b=getTrackPoint(i+1);var dx=b.x-a.x,dz=b.z-a.z;var l=Math.sqrt(dx*dx+dz*dz);return{x:dx/l,z:dz/l}}

// Find nearest track index
function nearestTrackIndex(wx,wz){
  var best=Infinity,bi=0;
  for(var i=0;i<TRACK_POINTS;i++){
    var p=trackNodes[i],dx=wx-p.x,dz=wz-p.z,d=dx*dx+dz*dz;
    if(d<best){best=d;bi=i}
  }
  return bi;
}

function trackDist(wx,wz){
  var i=nearestTrackIndex(wx,wz),p=trackNodes[i];
  return Math.sqrt((wx-p.x)*(wx-p.x)+(wz-p.z)*(wz-p.z));
}

// ===== ITEM BOXES =====
var itemBoxes=[], itemBoxMeshes=[];
function generateItemBoxes(scene){
  itemBoxes=[];itemBoxMeshes=[];
  for(var i=0;i<TRACK_POINTS;i+=10){
    var p=getTrackPoint(i),a=getTrackAngle(i);
    for(var j=-1;j<=1;j++){
      var ox=Math.cos(a+Math.PI/2)*j*8;
      var oz=Math.sin(a+Math.PI/2)*j*8;
      var box={x:p.x+ox,y:p.y+2.5,z:p.z+oz,active:true,respawn:0};
      itemBoxes.push(box);
      // Visual
      var geo=new THREE.BoxGeometry(2.2,2.2,2.2);
      var mat=new THREE.MeshPhongMaterial({color:0xFFDD00,emissive:0x996600,transparent:true,opacity:0.85});
      var mesh=new THREE.Mesh(geo,mat);
      mesh.position.set(box.x,box.y,box.z);
      scene.add(mesh);
      itemBoxMeshes.push(mesh);
    }
  }
}

// ===== TRAPS ON TRACK =====
var traps=[],trapMeshes=[];
function addTrap(scene,x,y,z){
  var trap={x:x,y:y,z:z,life:600};
  traps.push(trap);
  var geo=new THREE.SphereGeometry(1,8,6);
  var mat=new THREE.MeshPhongMaterial({color:0x333333,emissive:0x111111});
  var mesh=new THREE.Mesh(geo,mat);
  mesh.position.set(x,y+.5,z);
  scene.add(mesh);
  trapMeshes.push(mesh);
}

// ===== HOMING PROJECTILES =====
var projectiles=[],projMeshes=[];
function addProjectile(scene,x,y,z,ang,owner){
  var proj={x:x,y:y+1.5,z:z,ang:ang,spd:4,life:180,owner:owner};
  projectiles.push(proj);
  var geo=new THREE.SphereGeometry(.6,6,4);
  var mat=new THREE.MeshPhongMaterial({color:0xFF0000,emissive:0x880000});
  var mesh=new THREE.Mesh(geo,mat);
  mesh.position.set(proj.x,proj.y,proj.z);
  scene.add(mesh);
  projMeshes.push(mesh);
}

// ===== RACER =====
function Racer(charIdx,isPlayer){
  this.char=CHARACTERS[charIdx];
  this.charIdx=charIdx;
  this.isPlayer=isPlayer;
  this.x=0;this.y=0;this.z=0;this.ang=0;this.spd=0;
  this.maxSpd=1.6+this.char.s*0.16;
  this.accel=0.012+this.char.a*0.002;
  this.handling=0.02+this.char.h*0.0025;
  this.lap=0;this.totalIdx=0;this.progress=0;
  this.item=null;this.drifting=false;
  this.boostTimer=0;this.shieldTimer=0;this.stunTimer=0;
  this.finished=false;this.finTime=0;this.lastCP=-1;
  this.aiTargetIdx=0;this.aiInner=0;this.aiSkill=0.55+Math.random()*0.4;
  this.tilt=0;this.driftSpark=0;
  this.mesh=null;this.bodyMesh=null;this.headMesh=null;
  this.wheelMeshes=[];
}

Racer.prototype.placeAt=function(idx){
  var p=getTrackPoint(idx);
  this.x=p.x;this.y=p.y;this.z=p.z;
  this.ang=getTrackAngle(idx);
  this.totalIdx=idx;this.aiTargetIdx=idx+5;
};

Racer.prototype.createMesh=function(scene){
  this.mesh=new THREE.Group();
  // Body
  var bodyGeo=new THREE.BoxGeometry(2.4,1,3.5);
  var bodyMat=new THREE.MeshPhongMaterial({color:this.char.col});
  this.bodyMesh=new THREE.Mesh(bodyGeo,bodyMat);
  this.bodyMesh.position.y=0.6;
  this.bodyMesh.castShadow=true;
  this.mesh.add(this.bodyMesh);
  // Cabin
  var cabinGeo=new THREE.BoxGeometry(1.8,0.8,1.6);
  var cabinMat=new THREE.MeshPhongMaterial({color:0x88CCFF,transparent:true,opacity:0.6});
  var cabin=new THREE.Mesh(cabinGeo,cabinMat);
  cabin.position.set(0,1.2,-0.2);
  this.mesh.add(cabin);
  // Head
  var headGeo=new THREE.SphereGeometry(0.55,8,6);
  var headMat=new THREE.MeshPhongMaterial({color:0xFFDDBB});
  this.headMesh=new THREE.Mesh(headGeo,headMat);
  this.headMesh.position.set(0,1.7,-0.1);
  this.mesh.add(this.headMesh);
  // Helmet
  var helmetGeo=new THREE.SphereGeometry(0.6,8,6,0,Math.PI*2,0,Math.PI*0.6);
  var helmetMat=new THREE.MeshPhongMaterial({color:this.char.hc});
  var helmet=new THREE.Mesh(helmetGeo,helmetMat);
  helmet.position.set(0,1.8,-0.1);
  this.mesh.add(helmet);
  // Wheels
  var wGeo=new THREE.CylinderGeometry(0.4,0.4,0.3,8);
  var wMat=new THREE.MeshPhongMaterial({color:0x333333});
  var wPos=[[-1.3,0.3,1.2],[1.3,0.3,1.2],[-1.3,0.3,-1.2],[1.3,0.3,-1.2]];
  for(var i=0;i<4;i++){
    var w=new THREE.Mesh(wGeo,wMat);
    w.rotation.z=Math.PI/2;
    w.position.set(wPos[i][0],wPos[i][1],wPos[i][2]);
    w.castShadow=true;
    this.mesh.add(w);
    this.wheelMeshes.push(w);
  }
  // Exhaust pipes
  var exGeo=new THREE.CylinderGeometry(0.12,0.15,0.5,6);
  var exMat=new THREE.MeshPhongMaterial({color:0x888888});
  var ex1=new THREE.Mesh(exGeo,exMat);ex1.position.set(-0.5,0.4,1.9);ex1.rotation.x=Math.PI/2;
  var ex2=new THREE.Mesh(exGeo,exMat);ex2.position.set(0.5,0.4,1.9);ex2.rotation.x=Math.PI/2;
  this.mesh.add(ex1);this.mesh.add(ex2);

  this.mesh.position.set(this.x,this.y,this.z);
  this.mesh.rotation.y=-this.ang+Math.PI/2;
  scene.add(this.mesh);
};

Racer.prototype.update=function(input,racers,scene){
  if(this.finished){this.spd*=0.97;this.updateMesh();return}
  if(this.stunTimer>0){this.stunTimer--;this.spd*=0.92;this.updateMesh();return}
  if(this.boostTimer>0)this.boostTimer--;
  if(this.shieldTimer>0)this.shieldTimer--;
  if(this.driftSpark>0)this.driftSpark--;

  var curMax=this.boostTimer>0?this.maxSpd*1.4:this.maxSpd;

  if(this.isPlayer){
    // Player
    if(input.up)this.spd=Math.min(this.spd+this.accel,curMax);
    else if(input.down)this.spd=Math.max(this.spd-this.accel*1.5,-curMax*0.3);
    else this.spd*=0.985;

    this.drifting=input.drift&&Math.abs(this.spd)>0.5;
    var turnRate=this.handling*(this.drifting?1.6:1)*Math.min(1,Math.abs(this.spd)/0.8);
    if(input.left){this.ang+=turnRate;this.tilt=Math.min(this.tilt+0.03,0.15)}
    else if(input.right){this.ang-=turnRate;this.tilt=Math.max(this.tilt-0.03,-0.15)}
    else this.tilt*=0.9;

    if(this.drifting&&(input.left||input.right)){
      this.driftSpark=3;
      if(fr%20===0)SND.drift();
    }
  }else{
    // AI
    var tp=getTrackPoint(this.aiTargetIdx);
    var dx=tp.x-this.x,dz=tp.z-this.z;
    var targetAng=Math.atan2(dz,dx);
    var diff=targetAng-this.ang;
    while(diff>Math.PI)diff-=Math.PI*2;
    while(diff<-Math.PI)diff+=Math.PI*2;
    this.ang+=Math.max(-this.handling*1.2,Math.min(this.handling*1.2,diff*0.12));
    this.tilt=Math.max(-0.15,Math.min(0.15,diff*0.3));
    var dist=Math.sqrt(dx*dx+dz*dz);
    if(dist<15)this.aiTargetIdx=(this.aiTargetIdx+3)%TRACK_POINTS;
    this.spd=Math.min(this.spd+this.accel*this.aiSkill,curMax*this.aiSkill);

    // AI item use
    if(this.item&&Math.random()<0.008){
      this.useItem(racers,scene);
    }
  }

  // Move
  this.x+=Math.cos(this.ang)*this.spd;
  this.z+=Math.sin(this.ang)*this.spd;

  // Track Y
  var ni=nearestTrackIndex(this.x,this.z);
  var tp=trackNodes[ni];
  this.y+=(tp.y-this.y)*0.15;

  // Off-track slowdown
  var td=trackDist(this.x,this.z);
  if(td>TRACK_WIDTH*0.55){this.spd*=0.96}

  // Progress tracking
  var prevIdx=this.totalIdx%TRACK_POINTS;
  var moved=ni-prevIdx;
  if(moved>TRACK_POINTS/2)moved-=TRACK_POINTS;
  if(moved<-TRACK_POINTS/2)moved+=TRACK_POINTS;
  if(Math.abs(moved)<TRACK_POINTS/3){
    this.totalIdx+=moved;
    if(prevIdx>TRACK_POINTS*0.75&&ni<TRACK_POINTS*0.25){
      this.lap++;
      if(this.isPlayer)SND.lap();
    }
  }
  this.progress=this.lap*TRACK_POINTS+ni;

  // Item box collision
  for(var i=0;i<itemBoxes.length;i++){
    var ib=itemBoxes[i];
    if(!ib.active)continue;
    var dx2=this.x-ib.x,dz2=this.z-ib.z,d=dx2*dx2+dz2*dz2;
    if(d<9){
      if(!this.item){
        this.item=ITEMS[Math.floor(Math.random()*ITEMS.length)];
        if(this.isPlayer)SND.pick();
      }
      ib.active=false;ib.respawn=180;
    }
  }

  // Trap collision
  for(var i=traps.length-1;i>=0;i--){
    var tr=traps[i];
    var dx3=this.x-tr.x,dz3=this.z-tr.z;
    if(dx3*dx3+dz3*dz3<4&&this.shieldTimer<=0){
      this.stunTimer=45;this.spd*=-0.3;
      if(this.isPlayer)SND.hit();
      scene.remove(trapMeshes[i]);
      traps.splice(i,1);trapMeshes.splice(i,1);
    }
  }

  // Projectile collision
  for(var i=projectiles.length-1;i>=0;i--){
    var pr=projectiles[i];
    if(pr.owner===this)continue;
    var dx4=this.x-pr.x,dz4=this.z-pr.z;
    if(dx4*dx4+dz4*dz4<6&&this.shieldTimer<=0){
      this.stunTimer=50;this.spd*=-0.2;
      if(this.isPlayer)SND.hit();
      scene.remove(projMeshes[i]);
      projectiles.splice(i,1);projMeshes.splice(i,1);
    }
  }

  // Racer collision
  for(var i=0;i<racers.length;i++){
    if(racers[i]===this)continue;
    var r=racers[i];
    var cdx=this.x-r.x,cdz=this.z-r.z,cd=Math.sqrt(cdx*cdx+cdz*cdz);
    if(cd<3&&cd>0.01){
      var push=0.15/cd;
      this.x+=cdx*push;this.z+=cdz*push;
      r.x-=cdx*push;r.z-=cdz*push;
      this.spd*=0.95;r.spd*=0.95;
    }
  }

  this.updateMesh();
};

Racer.prototype.updateMesh=function(){
  if(!this.mesh)return;
  this.mesh.position.set(this.x,this.y,this.z);
  this.mesh.rotation.y=-this.ang+Math.PI/2;
  this.bodyMesh.rotation.z=this.tilt;
  // Wheel spin
  var ws=this.spd*0.5;
  for(var i=0;i<this.wheelMeshes.length;i++){
    this.wheelMeshes[i].rotation.x+=ws;
  }
  // Shield visual
  if(this.shieldTimer>0){
    this.bodyMesh.material.emissive.setHex(0x003388);
  }else if(this.boostTimer>0){
    this.bodyMesh.material.emissive.setHex(0x884400);
  }else if(this.stunTimer>0){
    this.bodyMesh.material.emissive.setHex(fr%6<3?0x888800:0x000000);
  }else{
    this.bodyMesh.material.emissive.setHex(0x000000);
  }
};

Racer.prototype.useItem=function(racers,scene){
  if(!this.item)return;
  var it=this.item;
  this.item=null;
  switch(it.type){
    case'boost':this.boostTimer=90;SND.boost();break;
    case'trap':addTrap(scene,this.x-Math.cos(this.ang)*5,this.y,this.z-Math.sin(this.ang)*5);break;
    case'homing':addProjectile(scene,this.x,this.y,this.z,this.ang,this);SND.hit();break;
    case'shield':this.shieldTimer=240;break;
    case'thunder':
      for(var i=0;i<racers.length;i++){
        if(racers[i]!==this&&racers[i].shieldTimer<=0){
          racers[i].stunTimer=40;racers[i].spd*=0.4;
        }
      }
      SND.hit();break;
  }
};

// ===== THREE.JS SCENE =====
var scene,camera,renderer,clock;
var racers=[],player;
var gameState='title',raceTime=0,fr=0,isMobile=false;
var selectedChar=2;

function initScene(){
  scene=new THREE.Scene();
  scene.background=new THREE.Color(0x87CEEB);
  scene.fog=new THREE.Fog(0x87CEEB,200,600);

  camera=new THREE.PerspectiveCamera(70,window.innerWidth/window.innerHeight,0.5,800);
  renderer=new THREE.WebGLRenderer({antialias:!isMobile,powerPreference:'high-performance'});
  renderer.setSize(window.innerWidth,window.innerHeight);
  renderer.setPixelRatio(Math.min(window.devicePixelRatio,isMobile?1.5:2));
  renderer.shadowMap.enabled=!isMobile;
  renderer.shadowMap.type=THREE.PCFSoftShadowMap;
  document.body.insertBefore(renderer.domElement,document.body.firstChild);

  // Lights
  var ambient=new THREE.AmbientLight(0x8899BB,0.6);
  scene.add(ambient);
  var sun=new THREE.DirectionalLight(0xFFEECC,1.0);
  sun.position.set(100,150,-80);
  if(!isMobile){
    sun.castShadow=true;
    sun.shadow.mapSize.width=1024;
    sun.shadow.mapSize.height=1024;
    sun.shadow.camera.near=10;
    sun.shadow.camera.far=500;
    sun.shadow.camera.left=-200;sun.shadow.camera.right=200;
    sun.shadow.camera.top=200;sun.shadow.camera.bottom=-200;
  }
  scene.add(sun);
  var hemi=new THREE.HemisphereLight(0x88BBFF,0x446622,0.4);
  scene.add(hemi);

  // Ground
  var groundGeo=new THREE.PlaneGeometry(1200,1200);
  var groundMat=new THREE.MeshPhongMaterial({color:0x44AA33});
  var ground=new THREE.Mesh(groundGeo,groundMat);
  ground.rotation.x=-Math.PI/2;
  ground.position.y=-1;
  ground.receiveShadow=true;
  scene.add(ground);

  // Track surface
  buildTrackMesh(scene);

  // Track borders & decorations
  buildTrackDecorations(scene);

  // Skybox (simple gradient sphere)
  var skyGeo=new THREE.SphereGeometry(500,16,12);
  var skyMat=new THREE.MeshBasicMaterial({color:0x5588CC,side:THREE.BackSide});
  var sky=new THREE.Mesh(skyGeo,skyMat);
  scene.add(sky);

  // Clouds
  for(var i=0;i<20;i++){
    var cGeo=new THREE.SphereGeometry(8+Math.random()*15,8,6);
    var cMat=new THREE.MeshBasicMaterial({color:0xFFFFFF,transparent:true,opacity:0.7});
    var cloud=new THREE.Mesh(cGeo,cMat);
    cloud.position.set((Math.random()-0.5)*800,60+Math.random()*40,(Math.random()-0.5)*800);
    cloud.scale.set(1+Math.random(),0.4+Math.random()*0.3,1+Math.random());
    scene.add(cloud);
  }

  clock=new THREE.Clock();
}

function buildTrackMesh(scene){
  // Create track as a ribbon
  var shape=[];
  for(var i=0;i<=TRACK_POINTS;i++){
    var idx=i%TRACK_POINTS;
    var p=trackNodes[idx];
    var a=getTrackAngle(idx);
    var nx=Math.cos(a+Math.PI/2),nz=Math.sin(a+Math.PI/2);
    shape.push(
      {x:p.x+nx*TRACK_WIDTH*0.5,y:p.y-0.3,z:p.z+nz*TRACK_WIDTH*0.5},
      {x:p.x-nx*TRACK_WIDTH*0.5,y:p.y-0.3,z:p.z-nz*TRACK_WIDTH*0.5}
    );
  }
  var geo=new THREE.BufferGeometry();
  var verts=[],uvs=[],indices=[];
  for(var i=0;i<shape.length;i++){
    verts.push(shape[i].x,shape[i].y,shape[i].z);
    uvs.push((i%2===0)?0:1, Math.floor(i/2)/TRACK_POINTS*20);
  }
  for(var i=0;i<shape.length-2;i+=2){
    indices.push(i,i+1,i+2, i+1,i+3,i+2);
  }
  geo.setAttribute('position',new THREE.Float32BufferAttribute(verts,3));
  geo.setAttribute('uv',new THREE.Float32BufferAttribute(uvs,2));
  geo.setIndex(indices);
  geo.computeVertexNormals();

  // Create checkered texture
  var canvas=document.createElement('canvas');
  canvas.width=64;canvas.height=256;
  var ctx=canvas.getContext('2d');
  ctx.fillStyle='#555';ctx.fillRect(0,0,64,256);
  for(var y=0;y<32;y++)for(var x=0;x<8;x++){
    if((x+y)%2===0){ctx.fillStyle='#666';ctx.fillRect(x*8,y*8,8,8)}
  }
  // Road markings
  ctx.fillStyle='#FFF';
  for(var y=0;y<256;y+=32){ctx.fillRect(30,y,4,16)}
  // Edge lines
  ctx.fillStyle='#FF3300';
  ctx.fillRect(0,0,3,256);ctx.fillRect(61,0,3,256);

  var tex=new THREE.CanvasTexture(canvas);
  tex.wrapS=tex.wrapT=THREE.RepeatWrapping;

  var mat=new THREE.MeshPhongMaterial({map:tex});
  var mesh=new THREE.Mesh(geo,mat);
  mesh.receiveShadow=true;
  scene.add(mesh);

  // Curbs
  buildCurbs(scene);
}

function buildCurbs(scene){
  for(var side=-1;side<=1;side+=2){
    var pts=[];
    for(var i=0;i<=TRACK_POINTS;i++){
      var idx=i%TRACK_POINTS;
      var p=trackNodes[idx],a=getTrackAngle(idx);
      var nx=Math.cos(a+Math.PI/2)*side,nz=Math.sin(a+Math.PI/2)*side;
      var w=TRACK_WIDTH*0.52;
      pts.push(
        {x:p.x+nx*w,y:p.y-0.2,z:p.z+nz*w},
        {x:p.x+nx*(w+2),y:p.y-0.2,z:p.z+nz*(w+2)}
      );
    }
    var geo=new THREE.BufferGeometry();
    var v=[],uv=[],idx2=[];
    for(var i=0;i<pts.length;i++){
      v.push(pts[i].x,pts[i].y,pts[i].z);
      uv.push(i%2,Math.floor(i/2)/TRACK_POINTS*50);
    }
    for(var i=0;i<pts.length-2;i+=2){
      idx2.push(i,i+1,i+2,i+1,i+3,i+2);
    }
    geo.setAttribute('position',new THREE.Float32BufferAttribute(v,3));
    geo.setAttribute('uv',new THREE.Float32BufferAttribute(uv,2));
    geo.setIndex(idx2);geo.computeVertexNormals();

    var cc=document.createElement('canvas');cc.width=16;cc.height=128;
    var cx=cc.getContext('2d');
    for(var y2=0;y2<16;y2++){
      cx.fillStyle=y2%2===0?'#FF0000':'#FFFFFF';
      cx.fillRect(0,y2*8,16,8);
    }
    var ct=new THREE.CanvasTexture(cc);ct.wrapS=ct.wrapT=THREE.RepeatWrapping;
    var cm=new THREE.MeshPhongMaterial({map:ct});
    scene.add(new THREE.Mesh(geo,cm));
  }
}

function buildTrackDecorations(scene){
  // Trees
  for(var i=0;i<80;i++){
    var angle=Math.random()*Math.PI*2;
    var dist=350+Math.random()*180;
    var tx=Math.cos(angle)*dist,tz=Math.sin(angle)*dist;
    // Also near track
    if(i<30){
      var ti=Math.floor(Math.random()*TRACK_POINTS);
      var tp=trackNodes[ti],ta=getTrackAngle(ti);
      var side2=(Math.random()>0.5?1:-1);
      var off=TRACK_WIDTH*0.7+5+Math.random()*15;
      tx=tp.x+Math.cos(ta+Math.PI/2)*side2*off;
      tz=tp.z+Math.sin(ta+Math.PI/2)*side2*off;
    }
    var treeH=6+Math.random()*6;
    // Trunk
    var trunkGeo=new THREE.CylinderGeometry(0.4,0.6,treeH*0.4,6);
    var trunkMat=new THREE.MeshPhongMaterial({color:0x885533});
    var trunk=new THREE.Mesh(trunkGeo,trunkMat);
    trunk.position.set(tx,treeH*0.2-1,tz);
    trunk.castShadow=!isMobile;
    scene.add(trunk);
    // Foliage
    var fGeo=new THREE.SphereGeometry(treeH*0.35,6,5);
    var fCol=[0x228833,0x33AA44,0x119922,0x44BB55][Math.floor(Math.random()*4)];
    var fMat=new THREE.MeshPhongMaterial({color:fCol});
    var foliage=new THREE.Mesh(fGeo,fMat);
    foliage.position.set(tx,treeH*0.55-1,tz);
    foliage.scale.y=1.2;
    foliage.castShadow=!isMobile;
    scene.add(foliage);
  }

  // Start/Finish banner
  var sp=getTrackPoint(0),sa=getTrackAngle(0);
  var bGeo=new THREE.BoxGeometry(TRACK_WIDTH+6,4,0.5);
  var bMat=new THREE.MeshPhongMaterial({color:0x222222});
  var banner=new THREE.Mesh(bGeo,bMat);
  banner.position.set(sp.x,sp.y+8,sp.z);
  banner.rotation.y=-sa+Math.PI/2;
  scene.add(banner);
  // Poles
  for(var s=-1;s<=1;s+=2){
    var pGeo=new THREE.CylinderGeometry(0.3,0.3,10,6);
    var pMat=new THREE.MeshPhongMaterial({color:0xCCCCCC});
    var pole=new THREE.Mesh(pGeo,pMat);
    var nx=Math.cos(sa+Math.PI/2)*s*(TRACK_WIDTH*0.5+3);
    var nz=Math.sin(sa+Math.PI/2)*s*(TRACK_WIDTH*0.5+3);
    pole.position.set(sp.x+nx,sp.y+4,sp.z+nz);
    scene.add(pole);
  }

  // Billboards/signs
  for(var i=0;i<6;i++){
    var bi=Math.floor(i*TRACK_POINTS/6+TRACK_POINTS/12);
    var bp=getTrackPoint(bi),ba=getTrackAngle(bi);
    var bSide=(i%2===0)?1:-1;
    var bOff=TRACK_WIDTH*0.5+8;
    var bx=bp.x+Math.cos(ba+Math.PI/2)*bSide*bOff;
    var bz=bp.z+Math.sin(ba+Math.PI/2)*bSide*bOff;
    var sGeo=new THREE.BoxGeometry(6,3,0.3);
    var sCol=[0xFF4400,0x0066FF,0xFFAA00,0x22CC44,0x8844CC,0xFF0066][i];
    var sMat=new THREE.MeshPhongMaterial({color:sCol,emissive:sCol,emissiveIntensity:0.2});
    var sign=new THREE.Mesh(sGeo,sMat);
    sign.position.set(bx,bp.y+5,bz);
    sign.rotation.y=-ba+Math.PI/2;
    scene.add(sign);
    var spGeo=new THREE.CylinderGeometry(0.2,0.2,6,4);
    var spMat=new THREE.MeshPhongMaterial({color:0x888888});
    var spole=new THREE.Mesh(spGeo,spMat);
    spole.position.set(bx,bp.y+2,bz);
    scene.add(spole);
  }
}

// ===== INPUT =====
var input={up:false,down:false,left:false,right:false,drift:false,item:false};
var keys={};

document.addEventListener('keydown',function(e){
  keys[e.code]=true;
  if(e.code==='Space'||e.code==='ArrowUp'||e.code==='ArrowDown')e.preventDefault();
  updateInput();
});
document.addEventListener('keyup',function(e){
  keys[e.code]=false;
  updateInput();
});
function updateInput(){
  input.up=keys['ArrowUp']||keys['KeyW']||false;
  input.down=keys['ArrowDown']||keys['KeyS']||false;
  input.left=keys['ArrowLeft']||keys['KeyA']||false;
  input.right=keys['ArrowRight']||keys['KeyD']||false;
  input.drift=keys['ShiftLeft']||keys['ShiftRight']||false;
  if(keys['Space']){input.item=true;keys['Space']=false}
}

// Mobile controls
function setupMobile(){
  var btns=document.querySelectorAll('.ctrl-btn');
  btns.forEach(function(btn){
    var key=btn.dataset.key;
    function on(e){e.preventDefault();initAudio();
      btn.classList.add('pressed');
      if(key==='up'||key==='accel')input.up=true;
      if(key==='down'||key==='brake')input.down=true;
      if(key==='left')input.left=true;
      if(key==='right')input.right=true;
      if(key==='drift')input.drift=true;
      if(key==='item'){input.item=true;setTimeout(function(){input.item=false},100)}
    }
    function off(e){e.preventDefault();
      btn.classList.remove('pressed');
      if(key==='up'||key==='accel')input.up=false;
      if(key==='down'||key==='brake')input.down=false;
      if(key==='left')input.left=false;
      if(key==='right')input.right=false;
      if(key==='drift')input.drift=false;
    }
    btn.addEventListener('touchstart',on,{passive:false});
    btn.addEventListener('touchend',off,{passive:false});
    btn.addEventListener('touchcancel',off,{passive:false});
  });
}

// ===== CHARACTER SELECT =====
function buildCharSelect(){
  var cont=document.getElementById('char-select');
  cont.innerHTML='';
  CHARACTERS.forEach(function(c,i){
    var card=document.createElement('div');
    card.className='char-card'+(i===selectedChar?' sel':'');
    var stats='';
    var attrs=[c.s,c.a,c.h];
    var labels=['SPD','ACC','HND'];
    for(var j=0;j<3;j++){
      stats+='<div style="display:flex;align-items:center;gap:2px;font-size:9px;color:rgba(255,255,255,.5)"><span>'+labels[j]+'</span><div class="char-stats">';
      for(var k=0;k<10;k++)stats+='<span'+(k<attrs[j]?' class="filled"':'')+' style="width:5px;height:5px"></span>';
      stats+='</div></div>';
    }
    card.innerHTML='<div class="emoji">'+c.e+'</div><div class="name">'+c.n+'</div><div class="type">'+c.d+'</div>'+stats;
    card.onclick=function(){
      initAudio();SND.cd();
      selectedChar=i;
      document.querySelectorAll('.char-card').forEach(function(cc){cc.classList.remove('sel')});
      card.classList.add('sel');
    };
    cont.appendChild(card);
  });
}

// ===== GAME FLOW =====
function startRace(){
  initAudio();
  document.getElementById('title-screen').style.display='none';

  generateTrack();
  initScene();

  // Create racers
  racers=[];
  player=new Racer(selectedChar,true);
  player.placeAt(0);
  player.createMesh(scene);
  racers.push(player);

  var aiChars=[];
  for(var i=0;i<CHARACTERS.length;i++){if(i!==selectedChar)aiChars.push(i)}
  for(var i=0;i<NUM_RACERS-1;i++){
    var ci=aiChars[i%aiChars.length];
    var ai=new Racer(ci,false);
    ai.placeAt(TRACK_POINTS-4-i*3);
    ai.createMesh(scene);
    racers.push(ai);
  }

  generateItemBoxes(scene);

  // Countdown
  gameState='countdown';
  var cdEl=document.getElementById('countdown');
  var cdNum=document.getElementById('cd-num');
  cdEl.style.display='flex';
  var count=3;
  cdNum.textContent=count;SND.cd();
  var cdInt=setInterval(function(){
    count--;
    if(count>0){cdNum.textContent=count;cdNum.style.animation='none';cdNum.offsetHeight;cdNum.style.animation='cdPop .8s ease-out';SND.cd()}
    else if(count===0){cdNum.textContent='GO!';cdNum.style.color='#0f0';cdNum.style.animation='none';cdNum.offsetHeight;cdNum.style.animation='cdPop .8s ease-out';SND.go()}
    else{cdEl.style.display='none';gameState='racing';clearInterval(cdInt)}
  },1000);

  document.getElementById('hud').style.display='block';
  document.getElementById('minimap').style.display='block';
  if(isMobile){
    document.getElementById('mobile-controls').style.display='block';
    document.getElementById('boost-bar').style.display='block';
  }

  raceTime=0;fr=0;
  animate();
}

function animate(){
  requestAnimationFrame(animate);
  fr++;

  if(gameState==='racing')raceTime++;

  // Update item boxes
  for(var i=0;i<itemBoxes.length;i++){
    var ib=itemBoxes[i];
    if(!ib.active){
      ib.respawn--;
      if(ib.respawn<=0)ib.active=true;
    }
    if(itemBoxMeshes[i]){
      itemBoxMeshes[i].visible=ib.active;
      if(ib.active)itemBoxMeshes[i].rotation.y+=0.03;
    }
  }

  // Update projectiles
  for(var i=projectiles.length-1;i>=0;i--){
    var pr=projectiles[i];
    // Find nearest enemy
    var nearest=null,nd=Infinity;
    for(var j=0;j<racers.length;j++){
      if(racers[j]===pr.owner)continue;
      var ddx=racers[j].x-pr.x,ddz=racers[j].z-pr.z,dd=ddx*ddx+ddz*ddz;
      if(dd<nd){nd=dd;nearest=racers[j]}
    }
    if(nearest){
      var ta=Math.atan2(nearest.z-pr.z,nearest.x-pr.x);
      var diff2=ta-pr.ang;
      while(diff2>Math.PI)diff2-=Math.PI*2;
      while(diff2<-Math.PI)diff2+=Math.PI*2;
      pr.ang+=Math.max(-0.06,Math.min(0.06,diff2));
    }
    pr.x+=Math.cos(pr.ang)*pr.spd;
    pr.z+=Math.sin(pr.ang)*pr.spd;
    pr.life--;
    if(projMeshes[i])projMeshes[i].position.set(pr.x,pr.y,pr.z);
    if(pr.life<=0){scene.remove(projMeshes[i]);projectiles.splice(i,1);projMeshes.splice(i,1)}
  }

  // Update traps
  for(var i=traps.length-1;i>=0;i--){
    traps[i].life--;
    if(traps[i].life<=0){scene.remove(trapMeshes[i]);traps.splice(i,1);trapMeshes.splice(i,1)}
  }

  // Update racers
  if(gameState==='racing'){
    for(var i=0;i<racers.length;i++){
      racers[i].update(i===0?input:{},racers,scene);
    }
    // Player item use
    if(input.item&&player.item){
      player.useItem(racers,scene);
      input.item=false;
    }

    // Check finish
    if(player.lap>=TOTAL_LAPS&&!player.finished){
      player.finished=true;
      player.finTime=raceTime;
      SND.fin();
    }
    // AI finish
    for(var i=1;i<racers.length;i++){
      if(racers[i].lap>=TOTAL_LAPS&&!racers[i].finished){
        racers[i].finished=true;
        racers[i].finTime=raceTime;
      }
    }
    // All finished?
    var allDone=true;
    for(var i=0;i<racers.length;i++){if(!racers[i].finished)allDone=false}
    if(allDone||raceTime>60*180)showResults();
  }

  // Camera
  if(player){
    var camDist=12,camH=6;
    var cx=player.x-Math.cos(player.ang)*camDist;
    var cz=player.z-Math.sin(player.ang)*camDist;
    var cy=player.y+camH;
    camera.position.lerp(new THREE.Vector3(cx,cy,cz),0.08);
    var lookAt=new THREE.Vector3(player.x,player.y+1.5,player.z);
    camera.lookAt(lookAt);
  }

  renderer.render(scene,camera);
  updateHUD();
  drawMinimap();
}

// ===== HUD =====
function updateHUD(){
  if(gameState!=='racing'&&gameState!=='countdown')return;
  // Sort by progress
  var sorted=racers.slice().sort(function(a,b){return b.progress-a.progress});
  var pos=1;
  for(var i=0;i<sorted.length;i++){if(sorted[i]===player){pos=i+1;break}}
  var suffixes=['st','nd','rd','th','th','th'];
  document.getElementById('position-display').innerHTML=pos+'<span class="suffix">'+suffixes[pos-1]+'</span>';
  document.getElementById('lap-display').textContent='LAP '+Math.min(player.lap+1,TOTAL_LAPS)+'/'+TOTAL_LAPS;
  document.getElementById('speed-display').textContent=Math.abs(Math.round(player.spd*60))+' km/h';

  var t=raceTime/60;
  var mins=Math.floor(t/60);
  var secs=t%60;
  document.getElementById('time-display').textContent=mins+':'+('0'+Math.floor(secs)).slice(-2)+'.'+('0'+Math.floor((secs%1)*100)).slice(-2);

  var itemBox=document.getElementById('item-box');
  itemBox.textContent=player.item?player.item.e:'';

  // Boost bar
  if(isMobile){
    var bFill=document.getElementById('boost-fill');
    if(player.boostTimer>0)bFill.style.width=(player.boostTimer/90*100)+'%';
    else bFill.style.width='0%';
  }

  // Warning flash
  var wf=document.getElementById('warning-flash');
  if(player.stunTimer>0)wf.style.opacity='0.6';
  else wf.style.opacity='0';
}

// ===== MINIMAP =====
function drawMinimap(){
  var mc=document.getElementById('minimap');
  if(!mc||mc.style.display==='none')return;
  var ctx=mc.getContext('2d');
  var w=mc.width,h=mc.height;
  ctx.clearRect(0,0,w,h);

  // Find bounds
  var minX=Infinity,maxX=-Infinity,minZ=Infinity,maxZ=-Infinity;
  for(var i=0;i<trackNodes.length;i++){
    var p=trackNodes[i];
    if(p.x<minX)minX=p.x;if(p.x>maxX)maxX=p.x;
    if(p.z<minZ)minZ=p.z;if(p.z>maxZ)maxZ=p.z;
  }
  var range=Math.max(maxX-minX,maxZ-minZ)*1.15;
  var ox=(w-(maxX-minX)/range*w)/2;
  var oy=(h-(maxZ-minZ)/range*h)/2;
  function tx(x){return(x-minX)/range*w+ox}
  function tz(z){return(z-minZ)/range*h+oy}

  // Track
  ctx.strokeStyle='rgba(255,255,255,0.3)';ctx.lineWidth=4;ctx.lineCap='round';
  ctx.beginPath();
  for(var i=0;i<=trackNodes.length;i++){
    var p=trackNodes[i%trackNodes.length];
    if(i===0)ctx.moveTo(tx(p.x),tz(p.z));
    else ctx.lineTo(tx(p.x),tz(p.z));
  }
  ctx.closePath();ctx.stroke();

  // Racers
  for(var i=racers.length-1;i>=0;i--){
    var r=racers[i];
    ctx.fillStyle=r.isPlayer?'#FFFFFF':'#'+r.char.col.toString(16).padStart(6,'0');
    ctx.beginPath();
    ctx.arc(tx(r.x),tz(r.z),r.isPlayer?4:3,0,Math.PI*2);
    ctx.fill();
    if(r.isPlayer){
      ctx.strokeStyle='#FFD700';ctx.lineWidth=1.5;ctx.stroke();
    }
  }
}

// ===== RESULTS =====
function showResults(){
  gameState='results';
  var sorted=racers.slice().sort(function(a,b){
    if(a.finished&&!b.finished)return-1;
    if(!a.finished&&b.finished)return 1;
    if(a.finished&&b.finished)return a.finTime-b.finTime;
    return b.progress-a.progress;
  });
  var pPos=1;
  for(var i=0;i<sorted.length;i++){if(sorted[i]===player){pPos=i+1;break}}

  var titles=['üèÜ 1ST PLACE!','ü•à 2ND PLACE!','ü•â 3RD PLACE!'];
  document.getElementById('result-title').textContent=pPos<=3?titles[pPos-1]:pPos+'TH PLACE';

  var t=player.finTime/60;
  var mins=Math.floor(t/60),secs=t%60;
  document.getElementById('result-time').textContent='TIME: '+mins+':'+('0'+Math.floor(secs)).slice(-2)+'.'+('0'+Math.floor((secs%1)*100)).slice(-2);

  var list=document.getElementById('result-list');
  list.innerHTML='';
  sorted.forEach(function(r,i){
    var li=document.createElement('li');
    if(r.isPlayer)li.className='player';
    var rc=['g','s','b','','',''];
    var ft=r.finished?formatTime(r.finTime):'DNF';
    li.innerHTML='<span class="rank '+rc[i]+'">'+(i+1)+'</span><span>'+r.char.e+' '+r.char.n+'</span><span style="margin-left:auto;opacity:.7">'+ft+'</span>';
    list.appendChild(li);
  });

  document.getElementById('results').style.display='flex';
  document.getElementById('hud').style.display='none';
  document.getElementById('minimap').style.display='none';
  if(isMobile){
    document.getElementById('mobile-controls').style.display='none';
    document.getElementById('boost-bar').style.display='none';
  }
}

function formatTime(frames){
  var t=frames/60;var m=Math.floor(t/60),s=t%60;
  return m+':'+('0'+Math.floor(s)).slice(-2)+'.'+('0'+Math.floor((s%1)*100)).slice(-2);
}

// ===== INIT =====
function checkMobile(){
  isMobile='ontouchstart'in window||navigator.maxTouchPoints>0;
}

function checkOrientation(){
  var rp=document.getElementById('rotate-prompt');
  if(isMobile&&window.innerHeight>window.innerWidth){rp.style.display='flex'}
  else{rp.style.display='none'}
}

window.addEventListener('resize',function(){
  checkOrientation();
  if(renderer){
    renderer.setSize(window.innerWidth,window.innerHeight);
    camera.aspect=window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
  }
});

checkMobile();
checkOrientation();
buildCharSelect();
setupMobile();

document.getElementById('start-btn').onclick=function(){
  initAudio();
  startRace();
};
document.getElementById('retry-btn').onclick=function(){
  // Clean up
  if(renderer){
    renderer.dispose();
    renderer.domElement.remove();
  }
  traps=[];trapMeshes=[];projectiles=[];projMeshes=[];
  document.getElementById('results').style.display='none';
  document.getElementById('title-screen').style.display='flex';
  buildCharSelect();
};
</script>

</body>
</html>
